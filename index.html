<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Joe‚Äôs Pizzaria ‚Äî Entrega</title> <style>
    :root{--bg:#0f0f10;--card:#17181b;--muted:#9aa0a6;--txt:#f1f3f4;--brand:#ff7a00}
    *{box-sizing:border-box;font-sizing:16px;font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif}
    body{margin:0;background:var(--bg);color:var(--txt)}
    header{padding:16px;border-bottom:1px solid #25272c}
    header .top{display:flex;gap:12px;align-items:center}
    .logo{height:56px;width:auto;border-radius:10px;background:#efe1cd0f;padding:6px}
    header h1{margin:0;font-size:22px;line-height:1.2}
    header p{margin:6px 0 0;color:var(--muted)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #25272c;border-radius:12px;padding:14px;margin-bottom:16px}
    .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid #2a2e34;border-radius:10px;margin-bottom:10px}
    .item h3{margin:0 0 4px}
    .muted{color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2e34;background:#121316;color:var(--txt)}
    input[type=number]{width:80px;text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--brand);border:1px solid #b35400;color:#000;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#202127;border:1px solid #2a2e34;color:#e6e6e6}
    .pill{display:inline-block;background:#2b2f35;color:#cfd3d7;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #2a2e34}
    .cart-item:last-child{border-bottom:0}
    .total{display:flex;justify-content:space-between;margin-top:8px;font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    
    /* ESTILO NOVO: Aviso de √öltimas Unidades */
    .pill-warning {
      display: inline-block;
      padding: 2px 6px;
      margin-left: 8px;
      font-size: 0.75em;
      font-weight: 700;
      color: #856404;
      background-color: #ffe8a1;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="top">
      <img src="logo.png" alt="Logo Joe‚Äôs Pizzaria" class="logo" onerror="this.style.display='none'">
      <div>
        <h1>Joe‚Äôs Pizzaria ‚Äî Entrega</h1> <p>üçï Pizzas 28 cm ‚Äî valores por sabor</p>
      </div>
    </div>
    <p class="small">üßæ N¬∫ do pedido: <b id="pedidoId">‚Ä¶</b></p>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Card√°pio</h2>
      
      <h3>Pizzas Assadas (30 cm)</h3>
      <div id="menuAssadas"></div>

      <h3 style="margin-top: 16px;">Pizzas Congeladas</h3>
      <div id="menuCongeladas"></div>

      <p class="small">* Itens esgotados ficam desabilitados automaticamente.</p>
    </section>

    <section class="card">
      <h2>Carrinho</h2>
      <div id="cart"></div>
    </section>

    <section class="card">
      <h2>Dados para Entrega</h2> <div class="row">
        <div style="flex:1 1 260px">
          <label>Nome de quem est√° pedindo</label> <input id="cliente" placeholder="Ex.: Jos√© da Silva">
        </div>
      </div>
      
      <div class="row" style="margin-top:10px">
        <div style="flex:1 1 200px">
          <label>Rua e N√∫mero</label> <input id="ruaNumero" placeholder="Ex.: Rua Pampa, 101">
        </div>
        <div style="flex:1 1 100px">
          <label>Bloco</label> <input id="bloco" placeholder="Ex.: 16">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1 1 260px">
          <label>Ponto de Refer√™ncia / Complemento</label> <textarea id="complemento" rows="1" placeholder="Ex.: Apto 101"></textarea>
        </div>
      </div>
      
      <div class="row" style="margin-top:10px">
        <div style="flex:1 1 260px">
          <label>Observa√ß√µes do pedido</label>
          <textarea id="obs" rows="2" placeholder="Algum ajuste nos ingredientes?"></textarea>
        </div>
      </div>

    </section>

    <section class="card">
        <h2>Pagamento</h2>
        
        <div style="margin-bottom: 10px;">
          <label>Forma de Pagamento (para troco, informe nas observa√ß√µes)</label>
          <select id="formaPagamento">
            <option value="Pix">üí≥ Pix (Chave: 51998071649)</option>
            <option value="Credito">üí∞ Cart√£o de Cr√©dito</option>
            <option value="Debito">üí≥ Cart√£o de D√©bito</option>
            <option value="Dinheiro">üíµ Dinheiro</option>
          </select>
        </div>

        <div class="row" style="align-items:center">
          <div style="flex:1 1 auto" class="small">
            üí≥ Chave Pix: <b id="pixKey">51998071649</b>
          </div>
          <button id="copyPix" class="btn ghost" style="flex:0 0 auto">Copiar Pix</button>
        </div>

        <button id="btnEnviar" class="btn" style="margin-top:12px" disabled>Enviar pedido pelo WhatsApp</button>
        <p class="small">Abriremos o WhatsApp com o resumo do pedido para confirma√ß√£o.</p>
    </section>
  </main>

  <script>
    // ---- Config
    const WHATSAPP_NUMBER = "5551998071649";
    // ENDERE√áO DE RETIRADA FOI REMOVIDO/SUBSTITUIDO POR DADOS DO FORMUL√ÅRIO
    const PIX_KEY = document.getElementById('pixKey').textContent.trim();
    const TAMANHO = "30 cm";

    // N¬∫ do pedido (YYYYMMDD-###, reinicia por dia)
    function gerarNumeroPedido(){
      const d = new Date();
      const dia = d.toISOString().slice(0,10).replace(/-/g,'');
      const key = 'orders:'+dia;
      const n = (parseInt(localStorage.getItem(key) || '0',10) + 1);
      localStorage.setItem(key, String(n));
      return `${dia}-${String(n).padStart(3,'0')}`;
    }
    const PEDIDO_ID = gerarNumeroPedido();
    document.getElementById('pedidoId').textContent = PEDIDO_ID;

    // Util
    function formatBR(n){return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}

    // Estado
    const menuAssadasEl = document.getElementById('menuAssadas'); 
    const menuCongeladasEl = document.getElementById('menuCongeladas'); 
    let cart = [];
    let MENU_DATA = [];

    // Carregar menu (c√≥digo inalterado)
    async function carregarMenu(){
      try{
        const resp = await fetch('menu.json', {cache:'no-store'}); 
        MENU_DATA = await resp.json(); 

        menuAssadasEl.innerHTML = '';
        menuCongeladasEl.innerHTML = '';

        MENU_DATA.forEach(p=>{
          const estoque = Number(p.estoque ?? 0);
          const esgotado = p.available === false || estoque <= 0; 
          const price = Number(p.price ?? 0);
          
          const el = document.createElement('div');
          el.className = 'item';
          
          const itemTamanho = p.categoria === 'Pizzas Assadas' ? TAMANHO : '';
          
          const estoqueInfo = estoque > 0 && p.available ? ` | ${estoque} restantes` : ''; 
          
          el.innerHTML = `
            <div style="flex:1">
              <h3>${p.nome}${esgotado?'<span class="pill">Esgotada</span>':''}</h3>
              <div class="muted">${p.desc}</div>
              <div class="muted small">${estoqueInfo}</div>
              <div class="row" style="margin-top:8px">
                <input id="qty-${p.id}" type="number" min="1" value="1" ${esgotado?'disabled':''}>
                <button class="btn" ${esgotado?'disabled':''}
                        onclick="addToCart(${p.id},'${p.nome}',${price}, '${itemTamanho}', ${estoque})">Adicionar</button>
              </div>
            </div>
            <div style="font-weight:700">${formatBR(price)}</div>`;

          if(p.categoria === 'Pizzas Assadas'){
              menuAssadasEl.appendChild(el);
          } else if (p.categoria === 'Pizzas Congeladas') {
              menuCongeladasEl.appendChild(el);
          }
        });
      }catch(e){
        menuAssadasEl.innerHTML = '<p class="muted">‚ö†Ô∏è Erro ao carregar Card√°pio Assadas. Verifique o arquivo `menu.json`.</p>';
        menuCongeladasEl.innerHTML = '<p class="muted">‚ö†Ô∏è Erro ao carregar Card√°pio Congeladas. Verifique o arquivo `menu.json`.</p>';
        console.error("Erro ao carregar menu:", e);
      }
    }
    carregarMenu();

    // Carrinho e Estoque (c√≥digo inalterado)
    function addToCart(id, nome, precoUnit, tamanho, estoqueMaximo){ 
      const qty = parseInt(document.getElementById(`qty-${id}`).value||1,10);
      
      const existingItem = cart.find(i => i.nome === nome);
      const novaQtdeTotal = (existingItem ? existingItem.qty : 0) + qty;

      if (estoqueMaximo > 0 && novaQtdeTotal > estoqueMaximo) {
          const disponivel = estoqueMaximo - (existingItem ? existingItem.qty : 0);
          alert(`Desculpe, s√≥ temos ${estoqueMaximo} unidade(s) de ${nome} em estoque. Voc√™ j√° tem ${existingItem ? existingItem.qty : 0} no carrinho. Voc√™ pode adicionar no m√°ximo mais ${disponivel} unidade(s).`);
          return;
      }

      if (existingItem) {
        existingItem.qty = novaQtdeTotal; 
      } else {
        cart.push({id:Date.now(), nome, tamanho, precoUnit, qty, estoque: estoqueMaximo}); 
      }
      
      renderCart();
    }
    
    function removeItemByNome(nome){ 
        cart = cart.filter(i=>i.nome!==nome); 
        renderCart(); 
    }

    function renderCart(){
      const cartEl = document.getElementById('cart');
      if(cart.length===0){
        cartEl.innerHTML = '<p class="muted">Seu carrinho est√° vazio.</p>';
        document.getElementById('btnEnviar').disabled = true;
        return;
      }
      
      let html = cart.map(i=>{
        const estoqueAviso = i.estoque > 0 && i.qty >= i.estoque * 0.8 ? 
          `<span class="pill-warning">√öltimas unidades!</span>` : ''; 

        const tamanhoStr = i.tamanho ? '‚Äî ' + i.tamanho : '';

        return `
        <div class="cart-item">
          <div>
            <b>${i.qty}x ${i.nome}</b> ${tamanhoStr} ${estoqueAviso}
            <div class="small">${formatBR(i.precoUnit)} cada. Total: ${formatBR(i.precoUnit*i.qty)}</div>
          </div>
          <button class="btn ghost small" onclick="removeItemByNome('${i.nome}')">remover</button>
        </div>`}).join('');

      const total = cart.reduce((s,i)=>s+i.precoUnit*i.qty,0);
      html += `<div class="total"><span>Total</span><span>${formatBR(total)}</span></div>`;
      cartEl.innerHTML = html;

      // Valida√ß√£o agora checa nome, rua e bairro
      const nomeOk = (document.getElementById('cliente').value.trim().length > 0);
      const ruaOk = (document.getElementById('ruaNumero').value.trim().length > 0);
      const bairroOk = (document.getElementById('bairro').value.trim().length > 0);
      document.getElementById('btnEnviar').disabled = !(nomeOk && ruaOk && bairroOk);
    }

    // Adiciona listener para os novos campos de endere√ßo
    document.getElementById('cliente').addEventListener('input', renderCart);
    document.getElementById('ruaNumero').addEventListener('input', renderCart);
    document.getElementById('bairro').addEventListener('input', renderCart);

    // Copiar Pix (c√≥digo inalterado)
    document.getElementById('copyPix').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(PIX_KEY);
        const btn = document.getElementById('copyPix');
        const old = btn.textContent;
        btn.textContent = 'Copiada!';
        setTimeout(()=>btn.textContent=old, 1500);
      }catch(e){
        alert('N√£o foi poss√≠vel copiar. Chave Pix: ' + PIX_KEY);
      }
    });

    // WhatsApp (MUDADO PARA ENTRADA)
    function montarMensagem(){
      const cliente = document.getElementById('cliente').value.trim();
      const ruaNumero = document.getElementById('ruaNumero').value.trim();
      const bairro = document.getElementById('bairro').value.trim();
      const complemento = document.getElementById('complemento').value.trim();
      const obs = document.getElementById('obs').value.trim();
      const formaPagamento = document.getElementById('formaPagamento').value;
      const total = cart.reduce((s,i)=>s+i.precoUnit*i.qty,0);

      const linhas = [];
      linhas.push(`*-- NOVO PEDIDO --*`);
      linhas.push(`*Pedido:* ${PEDIDO_ID}`);
      linhas.push(`*Cliente:* ${cliente}`);
      
      linhas.push(`\nüìç *Entrega:*`);
      linhas.push(`Rua: ${ruaNumero}`);
      linhas.push(`Bairro: ${bairro}`);
      if(complemento) linhas.push(`Comp.: ${complemento}`);
      
      linhas.push(`\n*Itens:*`);
      cart.forEach(i => linhas.push(`‚Ä¢ ${i.qty}x ${i.nome} ${i.tamanho ? '(' + i.tamanho + ')' : ''} ‚Äî ${formatBR(i.precoUnit*i.qty)}`));
      
      linhas.push(`\n*Total:* ${formatBR(total)}`);
      
      linhas.push(`\n*Pagamento:* ${formaPagamento}`);
      if(formaPagamento === 'Pix') linhas.push(`_Chave Pix: ${PIX_KEY}_`);
      if(formaPagamento === 'Credito' || formaPagamento === 'Debito' || formaPagamento === 'Dinheiro') linhas.push(`(Levar maquininha/troco)`);
      
      if(obs) linhas.push(`\n*Observa√ß√µes:* ${obs}`);

      return linhas.join('\n');
    }

    document.getElementById('btnEnviar').addEventListener('click', ()=>{
      if(cart.length===0) return;
      
      // Checagem de campos obrigat√≥rios
      const cliente = document.getElementById('cliente').value.trim();
      const ruaNumero = document.getElementById('ruaNumero').value.trim();
      const bairro = document.getElementById('bairro').value.trim();
      
      if(!cliente || !ruaNumero || !bairro){ 
        alert('Por favor, preencha todos os dados de Nome e Endere√ßo para a entrega.'); 
        return; 
      }
      
      const msg = encodeURIComponent(montarMensagem());
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank');
    });
  </script>
</body>
</html>
