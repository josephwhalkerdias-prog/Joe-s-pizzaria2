<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Joe‚Äôs Pizzaria ‚Äî Retirada</title>
  <style>
    :root{--bg:#0f0f10;--card:#17181b;--muted:#9aa0a6;--txt:#f1f3f4;--brand:#ff7a00}
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif}
    body{margin:0;background:var(--bg);color:var(--txt)}
    header{padding:16px;border-bottom:1px solid #25272c}
    header .top{display:flex;gap:12px;align-items:center}
    .logo{height:56px;width:auto;border-radius:10px;background:#efe1cd0f;padding:6px}
    header h1{margin:0;font-size:22px;line-height:1.2}
    header p{margin:6px 0 0;color:var(--muted)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #25272c;border-radius:12px;padding:14px;margin-bottom:16px}
    .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid #2a2e34;border-radius:10px;margin-bottom:10px}
    .item h3{margin:0 0 4px}
    .muted{color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2e34;background:#121316;color:var(--txt)}
    input[type=number]{width:80px;text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--brand);border:1px solid #b35400;color:#000;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#202127;border:1px solid #2a2e34;color:#e6e6e6}
    .pill{display:inline-block;background:#2b2f35;color:#cfd3d7;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #2a2e34}
    .cart-item:last-child{border-bottom:0}
    .total{display:flex;justify-content:space-between;margin-top:8px;font-weight:700}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="top">
      <img src="logo.png" alt="Logo Joe‚Äôs Pizzaria" class="logo" onerror="this.style.display='none'">
      <div>
        <h1>Joe‚Äôs Pizzaria ‚Äî Retirada</h1>
        <p>üçï Pizzas 30 cm ‚Äî valores por sabor</p>
      </div>
    </div>
    <p class="small" style="margin-top:8px">üìç Retirada: <b>RUA ESQUADR√ÉO PAMPA - Bloco 16 - Apto 101</b></p>
    <p class="small">üßæ N¬∫ do pedido: <b id="pedidoId">‚Ä¶</b></p>
  </header>

  <main class="wrap">
    <section class="card">
    <h2>Card√°pio</h2>
    
    <h3>Pizzas Assadas (30 cm)</h3>
    <div id="menuAssadas"></div>

    <h3 style="margin-top: 16px;">Pizzas Congeladas</h3>
    <div id="menuCongeladas"></div>

    <p class="small">* Itens esgotados ficam desabilitados automaticamente.</p>
</section>

    <section class="card">
      <h2>Carrinho</h2>
      <div id="cart"></div>
    </section>

    <section class="card">
      <h2>Dados para retirada</h2>
      <div class="row">
        <div style="flex:1 1 260px">
          <label>Nome de quem vai retirar</label>
          <input id="cliente" placeholder="Ex.: Jos√© da Silva">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1 1 260px">
          <label>Observa√ß√µes do pedido (ex.: retirar cebola)</label>
          <textarea id="obs" rows="2" placeholder="Algum ajuste nos ingredientes?"></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:10px;align-items:center">
        <div style="flex:1 1 auto" class="small">üí≥ Chave Pix: <b id="pixKey">51998071649</b></div>
        <button id="copyPix" class="btn ghost" style="flex:0 0 auto">Copiar Pix</button>
      </div>

      <button id="btnEnviar" class="btn" style="margin-top:12px" disabled>Enviar pedido pelo WhatsApp</button>
      <p class="small">Abriremos o WhatsApp com o resumo do pedido para confirma√ß√£o.</p>
    </section>
  </main>

  <script>
    // ---- Config
    const WHATSAPP_NUMBER = "5551998071649";
    const ENDERECO_RETIRADA = "RUA ESQUADR√ÉO PAMPA - Bloco 16 - Apto 101";
    const PIX_KEY = document.getElementById('pixKey').textContent.trim();
    const TAMANHO = "30 cm";

    // N¬∫ do pedido (YYYYMMDD-###, reinicia por dia)
    function gerarNumeroPedido(){
      const d = new Date();
      const dia = d.toISOString().slice(0,10).replace(/-/g,'');
      const key = 'orders:'+dia;
      const n = (parseInt(localStorage.getItem(key) || '0',10) + 1);
      localStorage.setItem(key, String(n));
      return `${dia}-${String(n).padStart(3,'0')}`;
    }
    const PEDIDO_ID = gerarNumeroNumeroPedido();
    document.getElementById('pedidoId').textContent = PEDIDO_ID;

    // Util
    function formatBR(n){return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}

    // Estado
    const menuAssadasEl = document.getElementById('menuAssadas'); // Novo!
    const menuCongeladasEl = document.getElementById('menuCongeladas'); // Novo!
    let cart = [];

    // Carregar menu com PRE√áO por item (price no menu.json)
    async function carregarMenu(){
      try{
        const resp = await fetch('menu.json', {cache:'no-store'});
        const MENU = await resp.json();
        
        // Limpar os containers
        menuAssadasEl.innerHTML = '';
        menuCongeladasEl.innerHTML = '';

        MENU.forEach(p=>{
          const esgotado = p.available===false;
          const price = Number(p.price ?? 0);
          
          const el = document.createElement('div');
          el.className = 'item';
          
          // O tamanho (tamanho:TAMANHO) s√≥ ser√° usado para Pizzas Assadas
          const itemTamanho = p.categoria === 'Pizzas Assadas' ? TAMANHO : '';
          
          el.innerHTML = `
            <div style="flex:1">
              <h3>${p.nome}${esgotado?'<span class="pill">Esgotada</span>':''}</h3>
              <div class="muted">${p.desc}</div>
              <div class="row" style="margin-top:8px">
                <input id="qty-${p.id}" type="number" min="1" value="1" ${esgotado?'disabled':''}>
                <button class="btn" ${esgotado?'disabled':''}
                        onclick="addToCart(${p.id},'${p.nome}',${price}, '${itemTamanho}')">Adicionar</button>
              </div>
            </div>
            <div style="font-weight:700">${formatBR(price)}</div>`;

          // Novo! Adiciona o item na DIV correta baseada na categoria
          if(p.categoria === 'Pizzas Assadas'){
              menuAssadasEl.appendChild(el);
          } else if (p.categoria === 'Pizzas Congeladas') {
              menuCongeladasEl.appendChild(el);
          }
        });
      }catch(e){
        menuAssadasEl.innerHTML = '<p class="muted">N√£o consegui carregar o card√°pio de Pizzas Assadas.</p>';
        menuCongeladasEl.innerHTML = '<p class="muted">N√£o consegui carregar o card√°pio de Pizzas Congeladas.</p>';
      }
    }
    carregarMenu();

    // Carrinho
    function addToCart(id, nome, precoUnit, tamanho){
      const qty = parseInt(document.getElementById(`qty-${id}`).value||1,10);
      
      // Encontrar se o item j√° existe no carrinho pelo nome
      const existingItem = cart.find(i => i.nome === nome);

      if (existingItem) {
        // Se existir, apenas incrementa a quantidade
        existingItem.qty += qty;
      } else {
        // Se n√£o existir, adiciona como um novo item
        // O ID √© um timestamp, mas usamos o nome para agrupar.
        cart.push({id:Date.now(), nome, tamanho, precoUnit, qty}); 
      }
      
      renderCart();
    }
    
    // Agora o removeItem deve usar o 'nome' ou um ID √∫nico para o sabor, n√£o o Date.now()
    // Como estamos agrupando por nome, vamos alterar a fun√ß√£o de remo√ß√£o
    function removeItemByNome(nome){ 
        cart = cart.filter(i=>i.nome!==nome); 
        renderCart(); 
    }

    function renderCart(){
      const cartEl = document.getElementById('cart');
      if(cart.length===0){
        cartEl.innerHTML = '<p class="muted">Seu carrinho est√° vazio.</p>';
        document.getElementById('btnEnviar').disabled = true;
        return;
      }
      
      let html = cart.map(i=>`
        <div class="cart-item">
          <div>
            <b>${i.qty}x ${i.nome}</b> ${i.tamanho ? '‚Äî ' + i.tamanho : ''}
            <div class="small">${formatBR(i.precoUnit)} cada. Total: ${formatBR(i.precoUnit*i.qty)}</div>
          </div>
          <button class="btn ghost small" onclick="removeItemByNome('${i.nome}')">remover</button>
        </div>`).join('');

      const total = cart.reduce((s,i)=>s+i.precoUnit*i.qty,0);
      html += `<div class="total"><span>Total</span><span>${formatBR(total)}</span></div>`;
      cartEl.innerHTML = html;

      const nomeOk = (document.getElementById('cliente').value.trim().length > 0);
      document.getElementById('btnEnviar').disabled = !nomeOk;
    }

    document.getElementById('cliente').addEventListener('input', renderCart);

    // Copiar Pix
    document.getElementById('copyPix').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(PIX_KEY);
        const btn = document.getElementById('copyPix');
        const old = btn.textContent;
        btn.textContent = 'Copiada!';
        setTimeout(()=>btn.textContent=old, 1500);
      }catch(e){
        alert('N√£o foi poss√≠vel copiar. Chave Pix: ' + PIX_KEY);
      }
    });

    // WhatsApp
    function montarMensagem(){
      const cliente = document.getElementById('cliente').value.trim();
      const obs = document.getElementById('obs').value.trim();
      const total = cart.reduce((s,i)=>s+i.precoUnit*i.qty,0);

      const linhas = [];
      linhas.push(`*Pedido:* ${PEDIDO_ID}`);
      linhas.push(`*Cliente (retirada):* ${cliente}`);
      linhas.push(`\n*Itens:*`);
      // Monta as linhas, ignorando o tamanho se ele for vazio
      cart.forEach(i => linhas.push(`‚Ä¢ ${i.qty}x ${i.nome} ${i.tamanho ? '(' + i.tamanho + ')' : ''} ‚Äî ${formatBR(i.precoUnit*i.qty)}`));
      linhas.push(`\n*Total:* ${formatBR(total)}`);
      if(obs) linhas.push(`\n*Observa√ß√µes:* ${obs}`);
      linhas.push(`\nüìç *Retirar em:* ${ENDERECO_RETIRADA}`);
      linhas.push(`üí≥ *Pix:* ${PIX_KEY}`);

      return linhas.join('\n');
    }

    document.getElementById('btnEnviar').addEventListener('click', ()=>{
      if(cart.length===0) return;
      const cliente = document.getElementById('cliente').value.trim();
      if(!cliente){ alert('Informe o nome de quem vai retirar.'); return; }
      const msg = encodeURIComponent(montarMensagem());
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank');
    });
  </script>
